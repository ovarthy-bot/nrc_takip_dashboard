import Storage from './storage.js';
import UI from './ui.js';

const App = {
    state: {
        allData: [],
        filteredData: [],
        headers: ["WO", "Task Card", "Konu", "Ucak Tipi", "Tarih", "Bolge", "Durum", "Planlanan(MH)", "Gerceklesen(MH)", "Oran %", "Not"],
        filters: {},
        sort: {
            colIndex: -1,
            asc: true
        },
        pagination: {
            page: 1,
            pageSize: 100
        }
    },

    init: async function () {
        this.bindEvents();
        await this.loadData();
    },

    bindEvents: function () {

        const debounce = (fn, delay) => {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), delay);
            };
        };

        document.getElementById('fileInput')
            .addEventListener('change', (e) => this.handleFile(e));

        document.getElementById('search')
            .addEventListener('input',
                debounce((e) => this.handleSearch(e), 300)
            );

        document.getElementById('clearDataBtn')
            .addEventListener('click', () => this.clearData());

        document.getElementById('nextPage')
            ?.addEventListener('click', () => this.nextPage());

        document.getElementById('prevPage')
            ?.addEventListener('click', () => this.prevPage());
    },

    loadData: async function () {
        UI.toggleLoading(true);
        const data = await Storage.fetchAll();

        this.state.allData = data || [];
        this.state.filteredData = this.state.allData;
        this.state.pagination.page = 1;

        this.render();
        UI.toggleLoading(false);
    },

    clearData: function () {
        alert("Firestore Ã¼zerinden silme devre dÄ±ÅŸÄ±.");
    },

    handleFile: function (e) {
        const file = e.target.files[0];
        if (!file) return;

        UI.toggleLoading(true);

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                await this.processData(rows);
            } catch (err) {
                console.error(err);
                alert('Dosya okunamadÄ±');
            }
        };
        reader.readAsArrayBuffer(file);
    },

    processData: async function (rows) {

        if (!rows || rows.length < 2) return;

        const columns = [0, 1, 5, 6, 12, 7, 8, 15, 16];
        const existingMap = new Map();

        this.state.allData.forEach(r => {
            existingMap.set(r[0] + '_' + r[1], r);
        });

        const newData = [];

        for (let i = 1; i < rows.length; i++) {

            const row = rows[i];

            const mapped = columns.map((colIdx, idx) => {
                let cell = row[colIdx] ?? "";

                if (idx === 4 && typeof cell === 'number') {
                    cell = this.excelDateToJSDate(cell);
                }

                return cell;
            });

            let val1 = parseFloat(mapped[7]) || 0;
            let val2 = parseFloat(mapped[8]) || 0;
            let percentage = val1 !== 0 ? (val2 / val1) * 100 : 0;

            mapped.push(percentage.toFixed(2));

            const key = mapped[0] + '_' + mapped[1];
            const existing = existingMap.get(key);
            mapped.push(existing ? existing[10] || "" : "");

            newData.push(mapped);
        }

        await Storage.saveBatch(newData);

        // ðŸ”¥ Reload yerine direkt state gÃ¼ncelle
        this.state.allData = newData;
        this.state.filteredData = newData;
        this.state.pagination.page = 1;

        this.render();
        UI.toggleLoading(false);
        alert("Import tamamlandÄ±");
    },

    excelDateToJSDate: function (serial) {
        if (!serial || isNaN(serial)) return "";

        const utc_days = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);

        const day = String(date_info.getDate()).padStart(2, '0');
        const month = String(date_info.getMonth() + 1).padStart(2, '0');
        const year = date_info.getFullYear();

        return `${day}.${month}.${year}`;
    },

    handleSearch: function (e) {
        const query = e.target.value.toLowerCase();
        this.filterData(query);
    },

    filterData: function (query) {

        if (!query) {
            this.state.filteredData = this.state.allData;
        } else {
            this.state.filteredData = this.state.allData.filter(row =>
                row.some(cell =>
                    String(cell).toLowerCase().includes(query)
                )
            );
        }

        this.state.pagination.page = 1;
        this.render();
    },

    sortData: function (colIndex) {

        if (this.state.sort.colIndex === colIndex) {
            this.state.sort.asc = !this.state.sort.asc;
        } else {
            this.state.sort.colIndex = colIndex;
            this.state.sort.asc = true;
        }

        const { asc } = this.state.sort;

        this.state.filteredData.sort((a, b) => {

            let valA = a[colIndex];
            let valB = b[colIndex];

            const numA = parseFloat(valA);
            const numB = parseFloat(valB);

            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }

            return asc
                ? String(valA).localeCompare(String(valB))
                : String(valB).localeCompare(String(valA));
        });

        this.render();
    },

    nextPage: function () {
        const totalPages = Math.ceil(this.state.filteredData.length / this.state.pagination.pageSize);
        if (this.state.pagination.page < totalPages) {
            this.state.pagination.page++;
            this.render();
        }
    },

    prevPage: function () {
        if (this.state.pagination.page > 1) {
            this.state.pagination.page--;
            this.render();
        }
    },

    render: function () {

        const { page, pageSize } = this.state.pagination;
        const start = (page - 1) * pageSize;
        const end = start + pageSize;

        const pageData = this.state.filteredData.slice(start, end);

        UI.showData(this.state.headers, pageData);
    }
};

window.App = App;
export default App;

document.addEventListener('DOMContentLoaded', () => {
    App.init();
});
